## ISUCON4 Qualifier (PHP)

### スコア

|                | success | fail | score |
|---------------:|:-------:|:----:|:-----:|
|     初期値     |    7360 |    0 |  1590 |
|  コード変更後  |   10650 |    0 |  2301 |
| チューニング後 |       - |    - |     - |

### PHPコードの変更

#### 基本変更方針

- こちらがメインの課題とのことなので，チューニングはコードの変更を終えるまで一切行わない．
- 極端に下がらない限りスコアはあまり気にせず，スコアのための非現実的な変更も避ける．

#### 変更点

- `last_login()`内でDBアクセスを含む関数`current_user()`を呼び出していたが，返り値のうち使用しているのは`$user_id`のみであり，これは`$_SESSION['user_id']`で事足りるため削除．DBアクセス回数が減り，速くなると予想．
- `attempt_login()`にユーザ名のバリデーションが無いことが気になったので追加．速度のみを考えると無駄だが，ログインフォームのplaceholder値も設定されているため，追加したかった．（しかしユーザIDが『半角英数』と書かれているのに，テストデータはアンダーバーやピリオドを含んでおり大変遺憾）
- `attempt_login()`内のif-else文が`!empty($user)`を複数回実行する形になっており無駄に思えたので並び替え．
- `$pdo->prepare, bind, execute`のクエリ実行手順でプレースホルダを用いることはSQLインジェクション対策にとても重要だが，bindする値が特に無い場合はその恩恵が得られないため，より簡潔な`$pdo->query`に書き換え．要求以上のことを行わず適切な処理を行うことは，「ちりも積もればなんとやら」でいずれ処理速度にも響くものと考える．
- `$pdo->query`の返り値はtraversableである．これを利用してforeachを書き換え．速度面での変更理由は同上．
- `banned_ips()`および`locked_users()`のクエリ修正．閾値以上ログインを試みており，すべて失敗に終わっているユーザ/IPを取得するクエリは2重のSELECT文で書かれていたが，HAVING句を用いることで1つのSELECTで記述可能．問い合わせ回数を減らすことが出来る．更に，foreach内の問い合わせ回数を1回でも減らすべく，ループ前に1つクエリを追加して「そもそもログイン失敗数を全て合計しても閾値には届かない」といったユーザをあぶり出すことにした．
- `user_locked()`および`ip_banned()`はログインを試みる度に呼び出されるため，クエリの最適化がスコアに直結する．初期実装ではここにも2重のSELECT文があり，やや重いクエリとなっている．これをSELECT文1つとわずかな配列処理で書き換え．
