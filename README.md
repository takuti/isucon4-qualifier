## ISUCON4 Qualifier (PHP)

### スコア

|                |workload| success | fail | score |
|:---------------:|--:|-------:|----:|-----:|
|     初期値     |1|    7360 |    0 |  1590 |
|  コード変更後  |1|   10650 |    0 |  __2301__ |
| チューニング後 |1|    47720 |    0 | 10308 |
||__16__|124370|0|__26872__|
### PHPコードの変更

以下のような基本方針で取り組んだ．

- こちらがメインの課題なので，チューニングはコードの変更を終えるまで一切行わない．
- 極端に下がらない限りスコアはあまり気にせず，スコアのための非現実的な変更も避ける．

#### 不要なDBアクセスの削除

- `last_login()`内でDBアクセスを含む関数`current_user()`を呼び出していた
- しかし返り値のうち使用しているのは`$user_id`のみ
- これは`$_SESSION['user_id']`で事足りるため削除
- DBアクセス回数が減り，速くなると予想

#### ユーザ名のバリデーション

- `attempt_login()`にユーザ名のバリデーションが無いことが気になったので追加
- 速度のみを考えると無駄
- しかしログインフォームのplaceholder値も設定されているため，追加したかった（ユーザIDが『半角英数』と書かれているのに，テストデータはアンダーバーやピリオドを含んでおり大変遺憾）

#### if文の並び替え

- `attempt_login()`内のif-else文が`!empty($user)`を複数回実行する形になっており無駄に思えたので並び替え

#### PDOのクエリ実行関数の変更

- `$pdo->prepare, bind, execute`のクエリ実行手順でプレースホルダを用いることはSQLインジェクション対策にとても重要
- しかしbindする値が特に無い場合は生クエリと同等のため`$pdo->query`に書き換え
- 要求以上のことを行わない＝「ちりも積もればなんとやら」
- また，`$pdo->query`の返り値はtraversableであるため，これを利用してforeachを書き換え（速度面での変更理由は同上）

#### 重そうなクエリの見直し

- `banned_ips()`および`locked_users()`
  - 「閾値以上ログインを試みており，すべて失敗に終わっているユーザ/IPを取得する」クエリは2重のSELECT文で書かれていた
  - これはHAVING句を用いることで1つのSELECTで記述可能となり，問い合わせ回数を減らすことが出来る
  - 更に，foreach内の問い合わせ回数を1回でも減らすべく，ループ前に1つクエリを追加して「そもそもログイン失敗数を全て合計しても閾値には届かない」といったユーザをあぶり出した
- `user_locked()`および`ip_banned()`
  - ログインを試みる度に呼び出されるためクエリの最適化がスコアに直結
  - 初期実装ではここにも2重のSELECT文があり，やや重いクエリとなっている
  - これをSELECT文1つとわずかな配列処理で書き換え．

### チューニング

#### DBでインデックスの作成

`init.sh`の末尾に以下の2行を追加．

```
mysql -h ${myhost} -P ${myport} -u ${myuser} ${mydb} -e 'create index user_id on login_log(user_id);'
mysql -h ${myhost} -P ${myport} -u ${myuser} ${mydb} -e 'create index ip on login_log(ip);'
```

[スコア] success:41660, fail:0, score:8999

#### nginxの設定

worker processを4にした．

[スコア] success:47720, fail:0, score:10308

### workloadを増やす

途中で`cannot assign requested address`と大量に表示されたため，調べつつ対応．[[参考](http://d.hatena.ne.jp/download_takeshi/20091013/1255443592)]

4, 8, 16, 32と試し，failの無い最大スコアとなった16に設定．

[スコア] success:124370, fail:0, score:26872

### その他

- Limonade というフレームワークの選択が適切なのか悩んだ．Limonade を使わずに実装することや，過去に利用経験がある Smarty の利用も検討したが，結局いずれも実施せず．現実的な口座管理システムを考えたときに，開発の初期段階として軽量でありつつも最低限Webアプリケーションとしての機能を満足している Limonade を使うことはアリだろう，と結論づけた．
- クエリの最適化がまだできそうではあるが時間切れ．勉強になった．
- 実装だけ見ていたらチューニングをする時間が無くなってしまった．特にキャッシュ回りに挑戦したかったが，残念．

